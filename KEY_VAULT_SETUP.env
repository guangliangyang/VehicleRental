
# Key Vault Secrets Setup

This document provides the manual steps to configure Cosmos DB secrets in Azure Key Vault.

## Prerequisites

1. Azure CLI installed and logged in: `az login`
2. Key Vault `kv-vehicle-rental-dev` created (done by CI/CD)
3. Proper permissions to set secrets in Key Vault

## Manual Setup Commands

After the CI/CD pipeline creates the Key Vault infrastructure, run these commands to set up the Cosmos DB secrets:

```bash
# Set Cosmos DB endpoint
az keyvault secret set --vault-name "kv-vehicle-rental-dev" --name "cosmos-endpoint" --value "https://cosmos-db-vc2.documents.azure.com:443/"

# Set Cosmos DB primary key
az keyvault secret set --vault-name "kv-vehicle-rental-dev" --name "cosmos-key" --value "yourvalue"

# Set Cosmos DB database ID
az keyvault secret set --vault-name "kv-vehicle-rental-dev" --name "cosmos-database-id" --value "cosmosdb-vc2"

# Set Cosmos DB container ID
az keyvault secret set --vault-name "kv-vehicle-rental-dev" --name "cosmos-container-id" --value "cosmosdb-vc2-container"
```

## Verification

Verify the secrets are set correctly:

```bash
# List all secrets
az keyvault secret list --vault-name "kv-vehicle-rental-dev" --query "[].name" -o table

# Check specific secret (shows metadata only, not the value)
az keyvault secret show --vault-name "kv-vehicle-rental-dev" --name "cosmos-endpoint" --query "name"
```

## Deployment Order

1. **Run CI/CD Pipeline** - Creates Key Vault infrastructure
2. **Execute Manual Commands** - Set the secrets using commands above
3. **Run CI/CD Again** - Deploy container instance with Key Vault references

## Container Instance Environment Variables

The container will automatically receive these environment variables from Key Vault:

- `COSMOS_ENDPOINT` - Cosmos DB endpoint URL
- `COSMOS_KEY` - Cosmos DB primary access key
- `COSMOS_DATABASE_ID` - Database name (cosmosdb-vc2)
- `COSMOS_CONTAINER_ID` - Container name (cosmosdb-vc2-container)

## Security Notes

- Secrets are never stored in Git or visible in CI/CD logs
- Container Instance uses System Assigned Identity for Key Vault access
- Only the GET permission is granted to the container identity
- Service Principal used for CI/CD has LIST and SET permissions for initial setup

## Troubleshooting

If container startup fails after Key Vault setup:

1. Verify secrets exist in Key Vault
2. Check container identity has proper access policy
3. Verify Key Vault name matches in Terraform configuration
4. Check container logs for specific error messages